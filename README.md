# Sound Wave Propagation Simulation

A Python-based simulation of sound wave propagation in 2D and 3D space using the Finite Difference Time Domain (FDTD) method. A key application of this simulation is to generate data for training machine learning models to perform room mapping and reconstruction using echolocation from sensor data.

## Core Features

*   **N-Dimensional:** The code is designed to work generally for both 2D and 3D spaces.
*   **Boundary Conditions:** Currently implements simple hard walls (zero pressure at the edges).
*   **Performance:** Leverages **GPU acceleration** via CUDA and CuPy for significant performance gains in the simulation.
*   **Interactive and Customizable Setup:**
    *   An interactive **Matplotlib UI** allows for drawing obstacles (left-click) and placing sound sources/drivers (right-click).
    *   The brush size for drawing obstacles can be controlled with the mouse scroll wheel.
    *   Drivers can be placed at arbitrary locations and can have custom waveforms.
*   **Data Storage:** Simulation results are saved to HDF5 files using `h5py`, allowing for structured storage of parameters, driver definitions, and simulation data.

## Applications

*   **Echolocation and Room Mapping:** The sensor data generated by this simulation can be used as a training dataset for machine learning models. A key goal is to develop models that can perform room mapping and reconstruction from the simulated echolocation data, effectively allowing an agent to "see" its environment through sound.

## Methodology

The simulation implements the **Finite Difference Time Domain (FDTD)** algorithm to numerically solve the acoustic wave equation.

### The Acoustic Wave Equation

The propagation of sound waves is described by the acoustic wave equation, a second-order partial differential equation. For a homogeneous medium, the equation is:

$$ \nabla^2 p - \frac{1}{c^2} \frac{\partial^2 p}{\partial t^2} = 0 $$

Where:
-   `p` is the acoustic pressure
-   `c` is the speed of sound
-   `∇²` is the Laplace operator

### The FDTD Method

The FDTD method approximates the continuous derivatives in the wave equation with finite differences on a discrete grid. The second-order time and space derivatives are approximated using the central difference scheme.

For the time derivative:
$$ \frac{\partial^2 p}{\partial t^2} \approx \frac{p(t+\Delta t) - 2p(t) + p(t-\Delta t)}{\Delta t^2} $$

For the spatial derivative (Laplacian) in 2D:
$$ \nabla^2 p \approx \frac{p(x+\Delta x, y) - 2p(x, y) + p(x-\Delta x, y)}{\Delta x^2} + \frac{p(x, y+\Delta y) - 2p(x, y) + p(x, y-\Delta y)}{\Delta y^2} $$

By substituting these approximations into the wave equation and rearranging the terms, we can derive an explicit update equation for the pressure `p` at the next time step `t + Δt` based on the values at the current time `t` and the previous time `t - Δt`. This allows the simulation to evolve the pressure field over time.

## Code Structure

```
sound_simulation/
├── simulation/
│   ├── main.py
│   ├── simulate.py
│   ├── boundary.py
│   ├── generate.py
│   ├── visualize.py
│   ├── data_io.py
│   ├── interactive_setup.py
│   └── plots/ (contains output plots and videos)
├── inference/
│   ├── cnn1d.py
│   └── datasetformat.py
├── requirements.txt
└── README.md
```

The project is organized into two main directories: `simulation` and `inference`.

*   `simulation/`: Contains the core logic for the sound wave simulation.
    *   `main.py`: The main entry point for running simulations.
    *   `simulate.py`: Contains the core FDTD simulation loop.
    *   `boundary.py`: Defines the boundary conditions for the simulation domain.
    *   `generate.py`: Includes code for generating initial conditions and sound sources.
    *   `visualize.py`: Handles both 2D and 3D visualization of the simulation data.
    *   `data_io.py`: Manages saving and loading of simulation data to and from HDF5 files.
    *   `interactive_setup.py`: Provides the UI for interactively setting up simulation parameters, obstacles, and sources.
*   `inference/`: Contains code related to machine learning model inference. **(Work in Progress)**
    *   `cnn1d.py`: Defines a 1D Convolutional Neural Network model.
    *   `datasetformat.py`: Code for formatting data for use with the model.

## Core Dependencies

*   **Core Calculation:** NumPy, CuPy (for GPU acceleration)
*   **Visualization:** Matplotlib (2D plots and UI), PyVista (3D plots)
*   **Data Storage:** h5py
*   **Development:** Python, Conda, Git/GitHub

## Visuals

This is an example plot of a 2D simulation run:

![Sample 2D Simulation](https://github.com/kyleyhw/sound_simulation/raw/main/simulation/plots/sample_figure.png)

The following plots show data recorded from sensors placed in the environment:

![Sensor Timeseries](https://github.com/kyleyhw/sound_simulation/raw/main/simulation/plots/sensor_timeseries.png)
![Sensor FFT](https://github.com/kyleyhw/sound_simulation/raw/main/simulation/plots/sensor_fft.png)

## Future Work

*   Implementation of absorbing boundary conditions (e.g., PML - Perfectly Matched Layers).
*   Further optimizations for performance.
